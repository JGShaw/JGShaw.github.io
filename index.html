<html>
  <head>
    <title>Lap timer</title>
    <script src="jquery.js"></script>

    <style>
      table, th, td {
        border: 1px solid black;
      }

      td, th {
        width: 100px;
        text-align: center
      }
    </style>

  </head>
  <body>

    <label for="fname">Total Laps:</label>
    <input type="number" id="totalLaps" name="totalLaps" value="12"><br>

    <label for="fname">Lap target(s):</label>
    <input type="number" id="lapTarget" name="lapTarget" value="5"><br>

    <h1>Laps</h1>
    <table onclick=start() id="lapTimesTable">
      <th>Lap</th>
      <th>Lap time</th>
      <th>Total</th>
      <th>Expected finish from previous lap</th>
    </table>

    <script>
      let times = []

      var red = {color: "red", from: 2000, to: Infinity};
      var orange = {color: "orange", from: 0, to: 1999};
      var green = {color: "green", from: -2000, to: -1};
      var blue = {color: "blue", from: -Infinity, to: -2001};

      var thresholds = [blue, green, orange, red]
      var lapTarget = 0


      function start() {
        lapTarget = $("#lapTarget").val() * 1000
        document.getElementById("lapTimesTable").removeAttribute("onclick");
        document.body.onclick = lap
      }

      function lap() {
        times.push(Date.now())

        lapTime = (times[times.length - 1] - times[times.length - 2])
        totalTime = (times[times.length - 1] - times[0])

        setBackground(lapTime)

        $("#lapTimesTable").append($("<tr>")
          .append([
            $("<td>").text(times.length - 1),
            $("<td>").text(msToTime(lapTime)),
            $("<td>").text(msToTime(totalTime)),
            $("<td>").text(msToTime(totalTime + estimateRemainingTime(lapTime))),
          ])  
        )
      }

      function setBackground(lapTime) {
        diff = lapTime - lapTarget
        for (const t of thresholds) {
          if(diff >= t.from && diff <= t.to) {
            document.body.bgColor = t.color
            return
          }
        }
      }

      function estimateRemainingTime(lastLap) {
        lapsLeft = $("#totalLaps").val() - times.length + 1
        return lapsLeft * lastLap
      }

      <!-- https://stackoverflow.com/questions/19700283/how-to-convert-time-in-milliseconds-to-hours-min-sec-format-in-javascript -->
      function msToTime(duration) {
        var milliseconds = Math.floor(duration % 1000),
          seconds = Math.floor((duration / 1000) % 60),
          minutes = Math.floor((duration / (1000 * 60)) % 60),

        minutes = (minutes < 10) ? "0" + minutes : minutes;
        seconds = (seconds < 10) ? "0" + seconds : seconds;

        return minutes + ":" + seconds + "." + milliseconds.toString().padStart(3, "0");
      }

    </script>
  </body>
</html>
