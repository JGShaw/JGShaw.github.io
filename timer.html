<html>
  <head>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Lap timer</title>
    <meta name="theme-color" content="#fff">
  </head>
  <body onclick="lap()">

    <h1>Laps</h1>
    <table id="lapTimesTable">
      <th>Lap</th>
      <th>Lap time</th>
      <th>Total</th>
      <th>Expected finish from previous lap</th>
    </table>

    <script>
      let times = []

      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      const targetFirst =  Number(urlParams.get("targetFirst") * 1000)
      const targetFinishMs =  Number(urlParams.get("targetMinutes") * 60 * 1000) + Number(urlParams.get("targetSeconds") * 1000)
      const lapTarget = Number(urlParams.get("totalLaps"))

      const thresholds = [
        {color: "blue", from: -Infinity, to: -1001},
        {color: "green", from: -1000, to: -1},
        {color: "orange", from: 0, to: 999},
        {color: "red", from: 1000, to: Infinity},
      ]

      function lap() {
        times.push(Date.now())

        lapNumber = times.length - 1
        lapTime = (times[lapNumber] - times[lapNumber - 1])
        totalTime = (times[lapNumber] - times[0])
        estimatedFinishTime = totalTime + estimateRemainingTime(lapTime)

        setBackground(lapNumber, lapTime, estimatedFinishTime)
        addToTable(lapNumber, lapTime, totalTime, estimatedFinishTime)
      }

      function estimateRemainingTime(lastLap) {
        lapsLeft = lapTarget - times.length + 1
        return lapsLeft * lastLap
      }

      function setBackground(lapNumber, lapTime, estimatedFinishTime) {
        diff = 0
        if(lapNumber === 1) {
          diff = lapTime - targetFirst 
        } else {
          diff = estimatedFinishTime - targetFinishMs 
        }

        for (const t of thresholds) {
          if(diff >= t.from && diff <= t.to) {
            document.body.bgColor = t.color
            document.querySelector('meta[name="theme-color"]').setAttribute("content", t.color)
            return
          }
        }
      }

      function addToTable(lapNumber, lapTime, totalTime, estimatedFinishTime) {
        row = document.getElementById("lapTimesTable").insertRow(-1)
        row.insertCell(-1).innerHTML = lapNumber
        row.insertCell(-1).innerHTML = msToTime(lapTime)
        row.insertCell(-1).innerHTML = msToTime(totalTime)
        row.insertCell(-1).innerHTML = msToTime(estimatedFinishTime)
      }

      <!-- https://stackoverflow.com/questions/19700283/how-to-convert-time-in-milliseconds-to-hours-min-sec-format-in-javascript -->
      function msToTime(duration) {
        var milliseconds = Math.floor(duration % 1000),
          seconds = Math.floor((duration / 1000) % 60),
          minutes = Math.floor((duration / (1000 * 60)) % 60),

        minutes = (minutes < 10) ? "0" + minutes : minutes;
        seconds = (seconds < 10) ? "0" + seconds : seconds;

        return minutes + ":" + seconds + "." + milliseconds.toString().padStart(3, "0");
      }

    </script>
  </body>
</html>
